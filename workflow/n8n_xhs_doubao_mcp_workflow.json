{
  "name": "XHS Rewrite+Image+Preview+Publish (Doubao+MCP)",
  "nodes": [
    {
      "id": "Trigger",
      "type": "n8n-nodes-base.webhook",
      "name": "Start (Webhook)",
      "parameters": {
        "httpMethod": "POST",
        "path": "xhs/rewrite",
        "responseMode": "lastNode",
        "options": {}
      },
      "position": [200, 200]
    },
    {
      "id": "FetchNote",
      "type": "n8n-nodes-base.httpRequest",
      "name": "Fetch Note HTML",
      "parameters": {
        "url": "={{$json.note_url}}",
        "options": {
          "timeout": 30000
        }
      },
      "position": [450, 200]
    },
    {
      "id": "ParseNote",
      "type": "n8n-nodes-base.function",
      "name": "Parse Title/Body/Images",
      "parameters": {
        "functionCode": "// Simple parse; replace with robust DOM parsing\nconst html = items[0].json.data || items[0].json;\nfunction extract(regex){ const m = String(html).match(regex); return m? m[1] : ''; }\nconst title = extract(/<title>(.*?)<\\/title>/i) || extract(/id=\"detail-title\">([^<]+)/i);\nconst body = extract(/<div[^>]*class=\"note-content[^\"]*\"[^>]*>([\s\S]*?)<\\/div>/i) || extract(/id=\"detail-desc\">([\s\S]*?)<\\/div>/i);\nconst imgMatches = Array.from(String(html).matchAll(/<img[^>]*src=\"([^\"]+)\"/gi)).map(m=>m[1]);\nreturn [{ json: { title, body, images: imgMatches.slice(0,6) } }];"
      },
      "position": [700, 200]
    },
    {
      "id": "RewriteDoubao",
      "type": "n8n-nodes-base.httpRequest",
      "name": "Doubao: Rewrite Text",
      "parameters": {
        "method": "POST",
        "url": "={{$env.DOUBAO_CHAT_URL || 'https://api.doubao.com/v1/chat/completions'}}",
        "jsonParameters": true,
        "options": {
          "headers": {
            "Authorization": "Bearer {{$env.DOUBAO_API_KEY}}",
            "Content-Type": "application/json"
          }
        },
        "body": {
          "model": "={{$env.DOUBAO_CHAT_MODEL || 'doubao-1-5'}}",
          "messages": [
            {"role": "system", "content": "你是小红书运营文案助手。请将用户提供的正文重写为中性专业口吻，长度与原文相近（±10%），保留品牌/SKU词且不生成违法违规内容，标题≤20字、正文≤1000字。"},
            {"role": "user", "content": "标题：{{ $json.title }}\n正文：{{ $json.body }}"}
          ],
          "temperature": 0.6
        }
      },
      "position": [950, 180]
    },
    {
      "id": "MapRewrite",
      "type": "n8n-nodes-base.function",
      "name": "Map Rewrite Output",
      "parameters": {
        "functionCode": "const r = items[0].json;\nconst text = (r.choices?.[0]?.message?.content) || r.data || '';\n// naive split: first line as title, rest as content\nconst lines = String(text).trim().split(/\n+/);\nconst title = lines[0].slice(0, 20);\nconst content = lines.slice(1).join('\n').slice(0, 1000);\nreturn [{ json: { title, content } }];"
      },
      "position": [1200, 180]
    },
    {
      "id": "GenImagesDoubao",
      "type": "n8n-nodes-base.httpRequest",
      "name": "Doubao: Generate Images",
      "parameters": {
        "method": "POST",
        "url": "={{$env.DOUBAO_IMAGE_URL || 'https://api.doubao.com/v1/images/generations'}}",
        "jsonParameters": true,
        "options": {
          "headers": {
            "Authorization": "Bearer {{$env.DOUBAO_API_KEY}}",
            "Content-Type": "application/json"
          }
        },
        "body": {
          "model": "={{$env.DOUBAO_IMAGE_MODEL || 'doubao-image-1-5'}}",
          "prompt": "将原文主题重绘为清新自然、极简现代风格的图文封面与配图。主题：{{ $json.title }}。请生成 4 张图，保持风格统一。",
          "n": 4,
          "size": "1024x1024"
        }
      },
      "position": [950, 340]
    },
    {
      "id": "SaveImages",
      "type": "n8n-nodes-base.function",
      "name": "Save Images to Local",
      "parameters": {
        "functionCode": "const path = require('path');\nconst fs = require('fs');\nconst outDir = process.env.OUTPUT_IMG_DIR || '/home/user/workspace/output/images';\nif (!fs.existsSync(outDir)) fs.mkdirSync(outDir, { recursive: true });\nconst data = items[0].json;\nconst images = [];\nconst arr = data.data || data.images || [];\narr.forEach((img, i)=>{\n  const b64 = img.b64_json || img.base64 || null;\n  if (b64){\n    const file = path.join(outDir, `doubao_${Date.now()}_${i}.png`);\n    fs.writeFileSync(file, Buffer.from(b64, 'base64'));\n    images.push(file);\n  } else if (img.url){\n    images.push(img.url);\n  }\n});\nreturn [{ json: { images } }];"
      },
      "position": [1200, 340]
    },
    {
      "id": "Preview",
      "type": "n8n-nodes-base.webhook",
      "name": "Preview & Approve",
      "parameters": {
        "httpMethod": "POST",
        "path": "xhs/approve",
        "responseMode": "onReceived",
        "options": {
          "responseCode": 200,
          "responseData": "已接收确认，开始发布"
        }
      },
      "position": [1450, 260]
    },
    {
      "id": "PublishMCP",
      "type": "n8n-nodes-base.httpRequest",
      "name": "MCP: publish_content",
      "parameters": {
        "method": "POST",
        "url": "http://localhost:18060/mcp",
        "jsonParameters": true,
        "options": {
          "headers": {
            "Content-Type": "application/json"
          },
          "timeout": 60000
        },
        "body": {
          "jsonrpc": "2.0",
          "id": 1,
          "method": "tools/call",
          "params": {
            "name": "publish_content",
            "arguments": {
              "title": "={{$json.title}}",
              "content": "={{$json.content}}",
              "images": "={{$json.images}}"
            }
          }
        }
      },
      "position": [1700, 260]
    },
    {
      "id": "Respond",
      "type": "n8n-nodes-base.function",
      "name": "Respond",
      "parameters": {
        "functionCode": "return [{ json: { status: 'ok', message: '已发布（或已入队）', published: true } }];"
      },
      "position": [1950, 260]
    }
  ],
  "connections": {
    "Start (Webhook)": {"main": [[{"node": "Fetch Note HTML", "type": "main", "index": 0}]]},
    "Fetch Note HTML": {"main": [[{"node": "Parse Title/Body/Images", "type": "main", "index": 0}]]},
    "Parse Title/Body/Images": {"main": [[{"node": "Doubao: Rewrite Text", "type": "main", "index": 0}, {"node": "Doubao: Generate Images", "type": "main", "index": 0}]]},
    "Doubao: Rewrite Text": {"main": [[{"node": "Map Rewrite Output", "type": "main", "index": 0}]]},
    "Doubao: Generate Images": {"main": [[{"node": "Save Images to Local", "type": "main", "index": 0}]]},
    "Map Rewrite Output": {"main": [[{"node": "Preview & Approve", "type": "main", "index": 0}]]},
    "Save Images to Local": {"main": [[{"node": "Preview & Approve", "type": "main", "index": 0}]]},
    "Preview & Approve": {"main": [[{"node": "MCP: publish_content", "type": "main", "index": 0}]]},
    "MCP: publish_content": {"main": [[{"node": "Respond", "type": "main", "index": 0}]]}
  },
  "settings": {
    "env": {
      "DOUBAO_API_KEY": "PUT_YOUR_KEY",
      "DOUBAO_CHAT_URL": "https://api.doubao.com/v1/chat/completions",
      "DOUBAO_CHAT_MODEL": "doubao-1-5",
      "DOUBAO_IMAGE_URL": "https://api.doubao.com/v1/images/generations",
      "DOUBAO_IMAGE_MODEL": "doubao-image-1-5",
      "OUTPUT_IMG_DIR": "/home/user/workspace/output/images"
    }
  }
}
